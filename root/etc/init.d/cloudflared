#!/bin/sh /etc/rc.common
# Copyright (C) 2024
# Cloudflare Tunnel init script

START=99
STOP=10
USE_PROCD=1

PROG="/usr/bin/cloudflared"
CONFIG_DIR="/etc/cloudflared"
TOKEN_FILE="${CONFIG_DIR}/token"

get_token() {
    # 优先从 UCI 读取
    local token
    token=$(uci -q get cloudflared.config.token)
    if [ -n "$token" ]; then
        echo "$token"
        return
    fi
    # 备用：从文件读取
    if [ -f "$TOKEN_FILE" ]; then
        cat "$TOKEN_FILE" | tr -d '\n\r'
    fi
}

is_enabled() {
    local enabled
    enabled=$(uci -q get cloudflared.config.enabled)
    [ "$enabled" = "1" ]
}

start_service() {
    if ! is_enabled; then
        echo "Cloudflared is disabled"
        return 0
    fi

    local token
    token=$(get_token)

    if [ -z "$token" ]; then
        echo "Error: Token not configured. Please configure token in LuCI."
        return 1
    fi

    if [ ! -f "$PROG" ] || [ ! -x "$PROG" ]; then
        echo "Error: cloudflared binary not found. Please install it first."
        return 1
    fi

    # 保存 token 到文件（兼容性）
    mkdir -p "$CONFIG_DIR"
    echo -n "$token" > "$TOKEN_FILE"
    chmod 600 "$TOKEN_FILE"

    procd_open_instance cloudflared
    procd_set_param command $PROG tunnel run --token "$token"
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param respawn 3600 5 5
    procd_close_instance
}

stop_service() {
    killall cloudflared 2>/dev/null
}

service_triggers() {
    procd_add_reload_trigger "cloudflared"
}

reload_service() {
    stop
    start
}
